# 하이브리드 전력 수요 예측 시스템 아키텍처

## 시스템 개요

```
┌─────────────────────────────────────────────────────────────────────┐
│                    전력 수요 예측 시스템                              │
└─────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        데이터 파이프라인                              │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐               │
│  │ CSV 데이터   │──▶│  전처리      │──▶│  특징 생성   │               │
│  └─────────────┘   └─────────────┘   └─────────────┘               │
└─────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     하이브리드 모델 시스템                            │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────┐      │
│  │                    Trend Component                        │      │
│  │  ┌────────────────────────────────────────────────────┐  │      │
│  │  │  로그-선형 회귀 (OLS)                               │  │      │
│  │  │  y_trend = exp(β₀ + β₁ · t)                        │  │      │
│  │  └────────────────────────────────────────────────────┘  │      │
│  └──────────────────────────────────────────────────────────┘      │
│                             │                                        │
│                             ▼                                        │
│  ┌──────────────────────────────────────────────────────────┐      │
│  │                 Seasonality Component                     │      │
│  │  ┌────────────────────────────────────────────────────┐  │      │
│  │  │  Fourier 분석 (다중 계절성)                         │  │      │
│  │  │                                                     │  │      │
│  │  │  Daily:   Σ[aₖsin(2πkt/24) + bₖcos(2πkt/24)]      │  │      │
│  │  │  Weekly:  Σ[aₖsin(2πkt/168) + bₖcos(2πkt/168)]    │  │      │
│  │  │  Yearly:  Σ[aₖsin(2πkt/8766) + bₖcos(2πkt/8766)]  │  │      │
│  │  │                                                     │  │      │
│  │  │  + 외부 변수 (기온, 습도, 요일, 계절, 휴일)          │  │      │
│  │  └────────────────────────────────────────────────────┘  │      │
│  └──────────────────────────────────────────────────────────┘      │
│                             │                                        │
│                             ▼                                        │
│  ┌──────────────────────────────────────────────────────────┐      │
│  │                  Residual Component                       │      │
│  │  ┌────────────────────────────────────────────────────┐  │      │
│  │  │  Seq2Seq LSTM                                      │  │      │
│  │  │                                                     │  │      │
│  │  │  Encoder:                                          │  │      │
│  │  │    LSTM(input=1, hidden=H, layers=L, dropout=D)   │  │      │
│  │  │    Input: 168시간 (7일)                            │  │      │
│  │  │                                                     │  │      │
│  │  │  Decoder:                                          │  │      │
│  │  │    LSTM(input=1, hidden=H, layers=L, dropout=D)   │  │      │
│  │  │    + Attention (optional)                          │  │      │
│  │  │    + Teacher Forcing (training)                    │  │      │
│  │  │    Output: 24시간 (1일)                            │  │      │
│  │  └────────────────────────────────────────────────────┘  │      │
│  └──────────────────────────────────────────────────────────┘      │
│                             │                                        │
│                             ▼                                        │
│  ┌──────────────────────────────────────────────────────────┐      │
│  │              최종 예측 = Σ 모든 컴포넌트                  │      │
│  │                                                           │      │
│  │  y_forecast = y_trend + y_seasonality + y_residual       │      │
│  │                                                           │      │
│  │  (각 컴포넌트 24시간 예측)                                 │      │
│  └──────────────────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      학습 및 튜닝 시스템                              │
│                                                                      │
│  ┌────────────────────┐   ┌────────────────────┐                   │
│  │  Trend Training    │   │  Grid Search       │                   │
│  │  - OLS Regression  │   │  - Fourier K값 탐색 │                   │
│  │  - 학습: 1분        │   │  - 학습: 5-10분     │                   │
│  └────────────────────┘   └────────────────────┘                   │
│                                                                      │
│  ┌─────────────────────────────────────────────────────┐           │
│  │  LSTM Random Search (50회 반복)                     │           │
│  │                                                      │           │
│  │  탐색 공간:                                           │           │
│  │  - hidden_size: [64, 128, 256]                      │           │
│  │  - num_layers: [2, 3]                               │           │
│  │  - dropout: [0.1, 0.2, 0.3]                         │           │
│  │  - bidirectional: [False, True]                     │           │
│  │  - use_attention: [False, True]                     │           │
│  │  - batch_size: [32, 64]                             │           │
│  │  - learning_rate: [0.0005, 0.001, 0.005]            │           │
│  │  - teacher_forcing_ratio: [0.0, 0.3, 0.5, 0.7]      │           │
│  │  - scheduler: ['cosine', 'reduce']                  │           │
│  │                                                      │           │
│  │  학습: 1-2시간 (GPU)                                  │           │
│  └─────────────────────────────────────────────────────┘           │
└─────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      MLflow 실험 추적                                 │
│                                                                      │
│  실험: power-demand-hybrid-weekly                                    │
│                                                                      │
│  기록 내용:                                                           │
│  - Parameters: 모든 하이퍼파라미터                                     │
│  - Metrics: 학습/검증/테스트 지표                                      │
│  - Artifacts: 모델 파일, 설정, 예측 결과                               │
│  - Tags: 모델 버전, 날짜, 성능                                        │
└─────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      추론 파이프라인                                   │
│                                                                      │
│  입력: 최근 168시간 (7일) + 미래 외부 변수 (24시간)                    │
│                                                                      │
│  1. Trend 예측       ──▶ 미래 24시간 추세                            │
│  2. Seasonality 예측 ──▶ 미래 24시간 계절성                          │
│  3. Residual 예측    ──▶ 미래 24시간 잔차 (LSTM)                     │
│  4. 컴포넌트 합산    ──▶ 최종 24시간 예측                            │
│                                                                      │
│  출력: 24시간 예측값 + 컴포넌트별 기여도                               │
│                                                                      │
│  추론 시간: ~1초 (GPU)                                                │
└─────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      평가 및 모니터링                                  │
│                                                                      │
│  평가 지표:                                                           │
│  - MAE (Mean Absolute Error)                                        │
│  - RMSE (Root Mean Squared Error)                                   │
│  - MAPE (Mean Absolute Percentage Error)                            │
│  - SMAPE (Symmetric MAPE)                                           │
│  - R² Score                                                         │
│                                                                      │
│  Horizon별 지표 (1h ~ 24h):                                          │
│  - 각 예측 시점별 성능 분석                                            │
│  - 예측 시간이 멀수록 오차 증가 추세 분석                               │
└─────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   Grafana 시각화 (InfluxDB)                          │
│                                                                      │
│  대시보드:                                                            │
│  ┌───────────────────────────────────────────────────────┐         │
│  │  Panel 1: 24시간 예측 vs 실제                         │         │
│  │  - 시계열 그래프                                       │         │
│  │  - 예측값 (빨간색), 실제값 (파란색)                     │         │
│  └───────────────────────────────────────────────────────┘         │
│                                                                      │
│  ┌───────────────────────────────────────────────────────┐         │
│  │  Panel 2: 예측 컴포넌트                                │         │
│  │  - Trend (주황색)                                      │         │
│  │  - Seasonality (보라색)                                │         │
│  │  - Residual (초록색)                                   │         │
│  └───────────────────────────────────────────────────────┘         │
│                                                                      │
│  ┌───────────────────────────────────────────────────────┐         │
│  │  Panel 3: 평가 지표                                    │         │
│  │  - MAE, RMSE, MAPE, R²                                │         │
│  │  - Stat 패널 (큰 숫자 표시)                            │         │
│  └───────────────────────────────────────────────────────┘         │
│                                                                      │
│  ┌───────────────────────────────────────────────────────┐         │
│  │  Panel 4: Horizon별 MAE                               │         │
│  │  - 1h ~ 24h 각 시점별 오차                             │         │
│  │  - 시간에 따른 오차 증가 추세                           │         │
│  └───────────────────────────────────────────────────────┘         │
└─────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  자동 재학습 (Prefect Orchestration)                  │
│                                                                      │
│  스케줄: 매주 일요일 02:00 AM (Asia/Seoul)                            │
│                                                                      │
│  워크플로우:                                                          │
│  1. 데이터 로드 (최신 데이터)                                         │
│  2. Trend 모델 재학습                                                │
│  3. Fourier 모델 재학습 (Grid Search)                                │
│  4. LSTM 모델 재학습 (Random Search, 50회)                           │
│  5. 테스트 세트 평가                                                  │
│  6. 성능이 개선되면 프로덕션 모델 교체                                  │
│  7. MLflow에 실험 기록                                               │
│  8. Grafana에 결과 전송                                              │
│                                                                      │
│  예상 소요 시간: 1-2시간                                              │
│  알림: 재학습 완료 시 Slack/Email 알림 (선택)                         │
└─────────────────────────────────────────────────────────────────────┘
```

## 데이터 흐름

### 학습 단계

```
원시 데이터 (CSV)
    │
    ├─▶ Train Split (2019-2024.08)
    │       │
    │       ├─▶ Trend Fitting
    │       │       └─▶ trend_model.pkl
    │       │
    │       ├─▶ Detrending
    │       │       │
    │       │       ├─▶ Fourier Fitting (Grid Search)
    │       │       │       └─▶ fourier_model.pkl
    │       │       │
    │       │       └─▶ Residual Extraction
    │       │               │
    │       │               └─▶ LSTM Training (Random Search)
    │       │                       └─▶ lstm_model.pth
    │       │
    │       └─▶ MLflow Logging
    │
    ├─▶ Val Split (2024.08-2024.10)
    │       │
    │       └─▶ Hyperparameter Tuning
    │               └─▶ Best Model Selection
    │
    └─▶ Test Split (2024.10-)
            │
            └─▶ Final Evaluation
                    │
                    ├─▶ Overall Metrics
                    ├─▶ Horizon Metrics
                    └─▶ Grafana Dashboard
```

### 추론 단계

```
Historical Data (168h)
    │
    ├─▶ Trend Extrapolation ──────────▶ trend_forecast (24h)
    │
    ├─▶ Fourier Projection ───────────▶ seasonality_forecast (24h)
    │   + External Features (24h)
    │
    └─▶ LSTM Prediction ──────────────▶ residual_forecast (24h)
            │
            └─▶ Combine Components ──▶ final_forecast (24h)
                    │
                    ├─▶ CSV Export
                    ├─▶ Visualization
                    └─▶ Grafana Streaming
```

## 핵심 기술

### 1. Trend Modeling
- **방법**: 로그-선형 회귀 (OLS)
- **이유**: 지수적 성장 트렌드 포착
- **장점**: 빠른 학습, 안정적 예측
- **단점**: 비선형 트렌드 포착 제한

### 2. Seasonality Modeling
- **방법**: Fourier 분석 + 선형 회귀
- **주기**: 일간(24h), 주간(168h), 연간(8766h)
- **하이퍼파라미터**: 각 주기별 조화항 수 (Kd, Kw, Ky)
- **장점**: 복잡한 다중 계절성 모델링
- **단점**: 주기가 정확히 일치해야 함

### 3. Residual Modeling
- **방법**: Seq2Seq LSTM
- **아키텍처**: Encoder-Decoder
- **입력**: 168시간 (단변량)
- **출력**: 24시간
- **개선**: Attention, Bidirectional, Teacher Forcing
- **장점**: 비선형 단기 패턴 포착
- **단점**: 학습 시간이 오래 걸림

## 성능 특성

### 예상 성능

| Metric | 값 | 설명 |
|--------|-----|------|
| MAE | 500-800 MW | 평균 절대 오차 |
| RMSE | 800-1200 MW | 제곱근 평균 제곱 오차 |
| MAPE | 2-4% | 평균 절대 백분율 오차 |
| SMAPE | 2-4% | 대칭 MAPE |
| R² | 0.95-0.98 | 결정 계수 |

### 컴포넌트 기여도

| Component | 분산 설명력 | 예측 안정성 |
|-----------|------------|------------|
| Trend | ~70% | ★★★★★ |
| Seasonality | ~20% | ★★★★☆ |
| Residual | ~10% | ★★★☆☆ |

### Horizon별 성능

예측 시간이 멀어질수록 오차가 증가하는 경향:

```
MAE 증가율: ~2-3% per hour
1h:  MAE ~400 MW
6h:  MAE ~500 MW
12h: MAE ~600 MW
24h: MAE ~700 MW
```

## 시스템 요구사항

### 하드웨어

- **CPU**: 8코어 이상
- **RAM**: 16GB 이상
- **GPU**: NVIDIA GPU (8GB VRAM) 권장
- **Storage**: 50GB 이상

### 소프트웨어

- **OS**: Linux (Ubuntu 20.04+)
- **Python**: 3.10+
- **CUDA**: 11.8+ (GPU 사용 시)
- **Docker**: 20.10+ (서비스 배포용)

### 서비스

- **InfluxDB**: 시계열 데이터베이스
- **Grafana**: 시각화 대시보드
- **MLflow**: 실험 추적
- **Prefect**: 워크플로우 오케스트레이션

## 확장성

### 수평 확장

- **추론**: 여러 인스턴스에 부하 분산 가능
- **학습**: 분산 학습 (미구현, 향후 계획)
- **데이터**: Dask로 대용량 데이터 처리 가능

### 수직 확장

- **GPU**: 멀티 GPU 학습 지원
- **메모리**: 대용량 메모리로 배치 크기 증가
- **CPU**: 멀티코어로 데이터 전처리 가속

## 보안 고려사항

- **모델 보안**: 학습된 모델 암호화 저장
- **API 인증**: JWT 토큰 기반 인증
- **데이터 보안**: 민감 정보 마스킹
- **감사 로그**: 모든 예측 요청 기록

## 유지보수

### 일일
- [ ] 추론 로그 확인
- [ ] Grafana 대시보드 모니터링
- [ ] 이상 감지 알림 확인

### 주간
- [ ] 자동 재학습 결과 확인
- [ ] 성능 지표 리뷰
- [ ] MLflow 실험 정리

### 월간
- [ ] 모델 성능 종합 분석
- [ ] 하이퍼파라미터 조정 검토
- [ ] 시스템 리소스 사용량 분석

### 분기별
- [ ] 아키텍처 리뷰
- [ ] 새로운 기법 적용 검토
- [ ] 대규모 데이터 정리

## 향후 개선 계획

1. **앙상블 모델**: 여러 모델의 예측 결합
2. **실시간 학습**: Online Learning 적용
3. **외부 데이터**: 날씨 예보, 경제 지표 통합
4. **설명 가능성**: SHAP, LIME으로 예측 설명
5. **자동 모니터링**: 성능 저하 자동 감지 및 재학습
6. **A/B 테스트**: 여러 모델 버전 비교
7. **모바일 앱**: 실시간 예측 조회 앱

## 참고 문헌

1. Sutskever et al. (2014). "Sequence to Sequence Learning with Neural Networks"
2. Bahdanau et al. (2015). "Neural Machine Translation by Jointly Learning to Align and Translate"
3. Hyndman & Athanasopoulos (2018). "Forecasting: Principles and Practice"
4. Box et al. (2015). "Time Series Analysis: Forecasting and Control"

